<html>
   <title>MTA-RDE</title>
   <link rel="icon" type="image/x-icon" href="images/favicon.ico">
   <head>
     <link rel="stylesheet" href="style.css">
   </head>

   <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
   <script type="text/javascript">
     google.charts.load('current', {'packages':['table', 'corechart', 'bar']});
   </script>

   <body style="font-family: Arial, Helvetica, sans-serif;">

   <button onclick="topFunction()" id="topButton" title="Go to top">Top</button>

   <h2>MyTrueAncestry - Raw Data Extractor</h3>
   <button onclick="helpEnFunction()">Help (En)</button>
   <button onclick="helpHuFunction()">Help (Hu)</button>
   <button onClick="window.open('https://github.com/khelmric/mta-rde');"> 
     <span>Code Repo on Github</span>
   </button>

   <div id="helpEn" style="display:none">
     <ol>
       <li>Login to <a href="https://mytrueancestry.com">https://mytrueancestry.com</a>.</li>
       <li>Select one Kit. (If All Kits are selected only the first will be investigated.)</li>
       <li>Save the webpage in html format.</li>
       <li>On the <a href="http://oci.atomx.hu/mta-rde">http://oci.atomx.hu/mta-rde</a> select the html file(s). 
           (Selecting the second file allows a comparsion of two results.)</li>
     </ol>   
   </div>
   <div id="helpHu" style="display:none">
     <ol>
       <li>Jelentkezz be a <a href="https://mytrueancestry.com">https://mytrueancestry.com</a> oldalra.</li>
       <li>Válassz ki egy Kit-et. Az összes Kit kijelölése esetén csak az elsőt vizsgálja a program.</li>
       <li>Mentsd le a weboldalt html formátumban.</li>
       <li>A <a href="http://oci.atomx.hu/mta-rde">http://oci.atomx.hu/mta-rde</a> oldalon válaszd ki a html fájlt/fájlokat. 
           (A második fájl kiválasztásával összehasonlítható két különböző eredmény.)</li>
     </ol>
   </div>

  <script>
  //Get the button
  var mybutton = document.getElementById("topButton");

  window.onscroll = function() {scrollFunction()};

  function scrollFunction() {
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
      mybutton.style.display = "block";
    } else {
      mybutton.style.display = "none";
    }
  }

  function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }
  </script>


   <script>
     function helpHuFunction() {
       var divhelphu = document.getElementById("helpHu");
       var divhelpen = document.getElementById("helpEn");
       if (divhelphu.style.display === "none") {
         divhelphu.style.display = "block";
         divhelpen.style.display = "none"
       } else {
         divhelphu.style.display = "none";
       }
     }
     function helpEnFunction() {
       var divhelphu = document.getElementById("helpHu");
       var divhelpen = document.getElementById("helpEn");
       if (divhelpen.style.display === "none") {
         divhelpen.style.display = "block";
         divhelphu.style.display = "none"
       } else {
         divhelpen.style.display = "none";
       }
     }

    function chartDataTransform(textContent, mREGEX, sREGEX) {
      textContent = textContent.match(mREGEX);
      textContent = String(textContent);
      textContent = textContent.match(sREGEX);
      textContent = String(textContent);
      REGEX = /\"\s?\,\s?\"/g;
      textContent = textContent.replace(REGEX, ',');
      textContent = String(textContent);
      REGEX = /[\s\S]*?\[|\]|\"/g;
      textContent = textContent.replace(REGEX, '');
      textContent = String(textContent);
      return textContent;
    }

    function listSmallDataTransform(textContent, mREGEX, sREGEX1, sREGEX2, sREGEX3, sREGEX4, sREGEX5) {
      textContent = textContent.match(mREGEX);
      textContent = String(textContent);
      textContent = textContent.replace(/\s+\+\s+/g, '+');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX1, '');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX2, ';');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX3, ',');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX4, ' ');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX5, '');
      textContent = String(textContent);
      return textContent;
    }  

    function listDataTransform(textContent, matchNo, mREGEX, sREGEX1, sREGEX2, sREGEX3, sREGEX4, sREGEX5, sREGEX6) {
      textContent = textContent.match(mREGEX);
      textContent = String(textContent[matchNo]);
      textContent = textContent.matchAll(sREGEX1);
      textContent = Array.from(textContent);
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX2, '');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX3, ';');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX4, ',');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX5, '');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX6, ',');
      textContent = String(textContent);
      return textContent;
    }

    function getKitData(textContent, target, mREGEX, sREGEX1) {
      textContent = textContent.match(mREGEX);
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX1, '');
      textContent = String(textContent);
      kitContent = textContent.split('"');
      targetNameDiv = document.getElementById(target + '_name');
      targetNumberDiv = document.getElementById(target + '_number');
      targetNameDiv.innerHTML=kitContent[1];
      targetNumberDiv.innerHTML=kitContent[0];
      return kitContent[0];
    }

    function printChartAsTable(textContent, mainREGEX, subREGEX1, subREGEX2, subREGEX3, target) {
      chartLabels = chartDataTransform(textContent, mainREGEX, subREGEX1);
      chartLabelArray = chartLabels.split(',');

      tableDivId = document.getElementById(target + '_result');
      chart1DivId = document.getElementById(target + '_chart1');
      buttonsDivId = document.getElementById(target + '_buttons');

      chartData = chartDataTransform(textContent, mainREGEX, subREGEX2);
      chartDataArray = chartData.split(',');

      chartBgColor = chartDataTransform(textContent, mainREGEX, subREGEX3);
      chartBgColorArray = chartBgColor.split(',');

      var data = new google.visualization.DataTable();

      data.addColumn('string', 'Description');
      data.addColumn('number', 'Value');
      data.addColumn('string', 'Color');

      for (var i = 0; i < chartLabelArray.length; i++) {
        var dataValueAsInt = chartDataArray[i].replace(/\s?/g, '');
        if ( dataValueAsInt.search( /\./ ) == 2) {
          dataValueAsInt = dataValueAsInt + '0';
        }
        dataValueAsInt = parseInt(dataValueAsInt.replace(/\./, ''));
        var rowContent = 'data.addRow([chartLabelArray[i], {v: ' + dataValueAsInt + ', f: "' + chartDataArray[i] + '"}, {v: null, f: null, p: {style: "background-color: ' + chartBgColorArray[i] + ';"}}]);';
        eval(rowContent);
      }
      var table = new google.visualization.Table(tableDivId);
      table.draw(data, {showRowNumber: false, width: '100%', height: '100%', allowHtml: true});
 
      var chart1 = new google.visualization.PieChart(chart1DivId);
      chart1.draw(data, {
          width: '600', 
          height: '500',
          colors: chartBgColorArray,
          is3D: true,
          legend: {
            textStyle: {
              fontSize: 9
            }
          }
      });

      // Prepare and display download buttons
      var csvContent = google.visualization.dataTableToCsv(data);
      var csvData = new Blob([csvContent]);
      buttonsDivId.innerHTML = '<a href=\"' + chart1.getImageURI() + '\" download=\"chart.png\"> <button type=\"button\">\&\#8681\; .png</button></a>' + '<a href=\"' + URL.createObjectURL(csvData) + '\" download=\"data.csv\" type=\"text/csv\"><button type=\"button\">\&\#8681\; .csv</button></a>';
    }

    function printSmallListAsTable(textContent, mainREGEX, subREGEX1, subREGEX2, subREGEX3, subREGEX4, subREGEX5, target, tableHeader) {
      listContent = listSmallDataTransform(textContent, mainREGEX, subREGEX1, subREGEX2, subREGEX3, subREGEX4, subREGEX5);
      listContentLineArray = listContent.split(';');

      var data = new google.visualization.DataTable();

      tableDivId = document.getElementById(target + '_result');
      buttonsDivId = document.getElementById(target + '_buttons');

      headersArray = tableHeader.split(',');
      for (var i = 0; i < headersArray.length; i++) {
        data.addColumn('string', headersArray[i]);
      }

      for (var i = 0; i < listContentLineArray.length-1; i++) {        
        listContentElementArray = listContentLineArray[i].split(',');
        var rowContent = "";
        for (var j = 0; j < listContentElementArray.length; j++) {
          cleanVar = listContentElementArray[j].replace(/\<br\>|\'/g, '');
          if (rowContent) {
            rowContent += ", '" + cleanVar + "'";
          } else {
            rowContent = "data.addRow(['" + cleanVar + "'";
          }
        }
        rowContent += "]);";
        eval(rowContent);
      }
      var table = new google.visualization.Table(tableDivId);
      table.draw(data, {showRowNumber: false, width: '100%', height: '100%', allowHtml: true});

      // Prepare and display download buttons
      var csvContent = google.visualization.dataTableToCsv(data);
      var csvData = new Blob([csvContent]);
      buttonsDivId.innerHTML = '<a href=\"' + URL.createObjectURL(csvData) + '\" download=\"data.csv\" type=\"text/csv\"><button type=\"button\">\&\#8681\; .csv</button></a>';

    }

    function printListAsTable(textContent, matchNo, mainREGEX, subREGEX1, subREGEX2, subREGEX3, subREGEX4, subREGEX5, subREGEX6, target, tableHeader) {
      listContent = listDataTransform(textContent, matchNo, mainREGEX, subREGEX1, subREGEX2, subREGEX3, subREGEX4, subREGEX5, subREGEX6);
      listContentLineArray = listContent.split(';');

      var data = new google.visualization.DataTable();

      tableDivId = document.getElementById(target + '_result');
      buttonsDivId = document.getElementById(target + '_buttons');
 
      headersArray = tableHeader.split(',');
      for (var i = 0; i < headersArray.length; i++) {
        data.addColumn('string', headersArray[i]);
      }

      for (var i = 0; i < listContentLineArray.length-1; i++) {
        listContentElementArray = listContentLineArray[i].split(',');
        var rowContent = "";
        for (var j = 0; j < listContentElementArray.length; j++) {
          cleanVar = listContentElementArray[j].replace(/\<br\>|\'/g, '');
          if (rowContent) {
            rowContent += ", '" + cleanVar + "'";
          } else {
            rowContent = "data.addRow(['" + cleanVar + "'";
          }
        }
        rowContent += "]);";
        eval(rowContent);
      }
      var table = new google.visualization.Table(tableDivId);
      table.draw(data, {showRowNumber: false, width: '100%', height: '100%', allowHtml: true});

      // Prepare and display download buttons
      var csvContent = google.visualization.dataTableToCsv(data);
      var csvData = new Blob([csvContent]);
      buttonsDivId.innerHTML = '<a href=\"' + URL.createObjectURL(csvData) + '\" download=\"data.csv\" type=\"text/csv\"><button type=\"button\">\&\#8681\; .csv</button></a>';
    }
 
    async function openFileFunction(event,col) {

      for (let el of document.querySelectorAll('.header')) el.style.display = 'block';
      const selectedFile = event.target.files.item(0);
      textContent = await selectedFile.text();

      // Get Kit info from html text
      if (col == 1) {
        kitDivInfo="kit1";
      } else {
        kitDivInfo="kit2";
      }
      mainREGEXkit=/Kit\:.*show.*\<\/a\>/;
      subREGEX1kit=/.*id\=\"name|\ onclick[\s\S]*?\>|\<\/a\>/g;
      var kitNumber = getKitData(textContent, kitDivInfo, mainREGEXkit, subREGEX1kit);

      // Get ASB, DD, Y-DNA and mtDNA data from html text
      var mainREGEXasb = new RegExp('refreshFunctionChartAncient' + kitNumber + '\\(jobid\\) \\{[\\s\\S]*?\\}', "g");
      var mainREGEXdd =  new RegExp('refreshFunctionChartDDAncient' + kitNumber + '\\(jobid\\) \{[\\s\\S]*?\\}', "g");
      var mainREGEXydna = new RegExp('refreshFunctionChart' + kitNumber + '\\(job[\\s\\S]*?options', "g");
      var mainREGEXmtdna = new RegExp('\\#pieChartYData' + kitNumber + '[\\s\\S]*?document.getElementById\\(\\"pieChartX[\\s\\S]*?\\{[\\s\\S]*?\\}', "g");
      subREGEX1=/labels[\s\S]*?\]/g;
      subREGEX2=/data[\s\S]*?\]/g;
      subREGEX3=/backgroundColor[\s\S]*?\]/g;

      if (col == 1) {
        printChartAsTable(textContent, mainREGEXasb, subREGEX1, subREGEX2, subREGEX3, "asb1");
        printChartAsTable(textContent, mainREGEXdd, subREGEX1, subREGEX2, subREGEX3, "dd1");
        printChartAsTable(textContent, mainREGEXydna, subREGEX1, subREGEX2, subREGEX3, "ydna1");
        printChartAsTable(textContent, mainREGEXmtdna, subREGEX1, subREGEX2, subREGEX3, "mtdna1");
      } else {
        printChartAsTable(textContent, mainREGEXasb, subREGEX1, subREGEX2, subREGEX3, "asb2");
        printChartAsTable(textContent, mainREGEXdd, subREGEX1, subREGEX2, subREGEX3, "dd2");
        printChartAsTable(textContent, mainREGEXydna, subREGEX1, subREGEX2, subREGEX3, "ydna2");
        printChartAsTable(textContent, mainREGEXmtdna, subREGEX1, subREGEX2, subREGEX3, "mtdna2");
      }

      var mainREGEXsm = new RegExp('refreshFunctionGlobeHaplo' + kitNumber + '\\(samplemax\\) \\{[\\s\\S]*?\]\\;', "g");
      subREGEX1sm=/title[\s\S]*?\,/g;
      subREGEX2sm=/title\"\:\s?\"Sample\s?match\s?\#/g;
      subREGEX3sm=/\"\,\,|\"\,/g;
      subREGEX4sm=/Y-DNA\:\s?|mtDNA\:\s?|Age\:\s?|Genetic\s?Distance\:\s?|Archaeological\s?ID\:\s?/g;
      subREGEX5sm=/\r*|\n*/g;
      subREGEX6sm=/\:/g;
      smMatchNo=0;
      smTableHeader="No,Name,Y-DNA,mtDNA,Age,GD,Arch ID";

      mainREGEXddar=/dataDD\=\[[\s\S]*?\]\;/g;
      subREGEX1ddar=/title[\s\S]*?\,/g;;
      subREGEX2ddar=/title\"\:\s?\"Deep\s?Dive\s?match\:/g;
      subREGEX3ddar=/\"\,\,|\"\,/g;
      subREGEX4ddar=/Y-DNA\:\s?|mtDNA\:\s?|Age\:\s?|Longest\s?Shared\s?DNA\:\s?|Archaeological\s?ID\:\s?/g;
      subREGEX5ddar=/\r*|\n*/g;
      subREGEX6ddar=/\:/g;
      ddarMatchNo=1;
      ddarTableHeader="Name,Y-DNA,mtDNA,Age,Longest Shared DNA,Arch ID";

      mainREGEXcmod=/Your\s?closest\s?genetic\s?modern[\s\S]*?\<hr\>/;
      subREGEX1cmod=/Your\s?closest[\s\S]*?\<\/a\>|\<hr\>|\<br\>|\n/g;
      subREGEX2cmod=/\)/g;
      subREGEX3cmod=/\s+\(/g;
      subREGEX4cmod=/\_/g;
      subREGEX5cmod=/\(|^,|,$/g;
      cmodTableHeader="Name,GD";

      mainREGEXcanc=/Your\s?closest\s?Ancient\s?populations[\s\S]*?\<a/;
      subREGEX1canc=/Your\s?closest[\s\S]*?\<\/div\>\<\/div\>\<hr\>|\<br\>|\<\/font\>|\<font\s?color\=\"[\S]{6}\"\>|\<a|\n/g;
      subREGEX2canc=/\)/g;
      subREGEX3canc=/\s+\(/g;
      subREGEX4canc=/\_/g;
      subREGEX5canc=/\(|^,|,$|\s+/g;
      cancTableHeader="Name,GD";

      if (col == 1) {
        printSmallListAsTable(textContent, mainREGEXcanc, subREGEX1canc, subREGEX2canc, subREGEX3canc, subREGEX4canc, subREGEX5canc, "canc1", cancTableHeader);
        printSmallListAsTable(textContent, mainREGEXcmod, subREGEX1cmod, subREGEX2cmod, subREGEX3cmod, subREGEX4cmod, subREGEX5cmod, "cmod1", cmodTableHeader);
        printListAsTable(textContent, smMatchNo, mainREGEXsm, subREGEX1sm, subREGEX2sm, subREGEX3sm, subREGEX4sm, subREGEX5sm, subREGEX6sm, "sm1", smTableHeader);
        printListAsTable(textContent, ddarMatchNo, mainREGEXddar, subREGEX1ddar, subREGEX2ddar, subREGEX3ddar, subREGEX4ddar, subREGEX5ddar, subREGEX6ddar, "ddar1", ddarTableHeader);
      } else {
        printSmallListAsTable(textContent, mainREGEXcanc, subREGEX1canc, subREGEX2canc, subREGEX3canc, subREGEX4canc, subREGEX5canc, "canc2", cancTableHeader);
        printSmallListAsTable(textContent, mainREGEXcmod, subREGEX1cmod, subREGEX2cmod, subREGEX3cmod, subREGEX4cmod, subREGEX5cmod, "cmod2", cmodTableHeader);
        printListAsTable(textContent, smMatchNo, mainREGEXsm, subREGEX1sm, subREGEX2sm, subREGEX3sm, subREGEX4sm, subREGEX5sm, subREGEX6sm, "sm2", smTableHeader);
        printListAsTable(textContent, ddarMatchNo, mainREGEXddar, subREGEX1ddar, subREGEX2ddar, subREGEX3ddar, subREGEX4ddar, subREGEX5ddar, subREGEX6ddar, "ddar2", ddarTableHeader);
      }
    }

   </script>

  <div class="row">
    <div class="column">
      <input type="file" style="width:400" ACCEPT="text/html" onchange="openFileFunction(event,1)" />
    </div>
    <div class="column">
      <input type="file" style="width:400" ACCEPT="text/html" onchange="openFileFunction(event,2)" />
    </div>
  </div>
  <div class="row">
    <div class="column">
      <p>Kit: (<b id="kit1_name"></b>)[<b id="kit1_number"></b>]</p>
    </div>
    <div class="column">
      <p>Kit: (<b id="kit2_name"></b>)[<b id="kit2_number"></b>]</p>
    </div>
  </div>


  <hr>

  <div class="row" id="asb">
    <h3 class="header" style="display:none">Ancient Samples Full Breakdown</h3>
    <div class="column">
      <div id="asb1_buttons"></div>
      <div id="asb1_chart1"></div>
      <div id="asb1_result"></div>
    </div>
    <div class="column">
      <div id="asb2_buttons"></div>
      <div id="asb2_chart1"></div>
      <div id="asb2_result"></div>
    </div>
  </div>

  <hr class="header" style="display:none">

  <div class="row" id="dd">
    <h3 class="header" style="display:none">Deep Dive Full Breakdown</h3>
    <div class="column">
      <div id="dd1_buttons"></div>
      <div id="dd1_chart1"></div>
      <div id="dd1_result"></div>
    </div>
    <div class="column">
      <div id="dd2_buttons"></div>
      <div id="dd2_chart1"></div>
      <div id="dd2_result"></div>
    </div>
  </div>

  <hr class="header" style="display:none">

  <div class="row" id="canc">
    <h3 class="header" style="display:none">Closest Ancient Populations</h3>
    <div class="column">
      <div id="canc1_buttons"></div>
      <div id="canc1_result"></div>
    </div>
    <div class="column">
      <div id="canc2_buttons"></div>
      <div id="canc2_result"></div>
    </div>
  </div>

  <hr class="header" style="display:none">

  <div class="row" id="cmod">
    <h3 class="header" style="display:none">Closest Modern Populations</h3>
    <div class="column">
      <div id="cmod1_buttons"></div>
      <div id="cmod1_result"></div>
    </div>
    <div class="column">
      <div id="cmod2_buttons"></div>
      <div id="cmod2_result"></div>
    </div>
  </div>

  <hr class="header" style="display:none">

  <div class="row" id="ydna">
    <h3 class="header" style="display:none">Y-DNA Breakdown</h3>
    <div class="column">
      <div id="ydna1_buttons"></div>
      <div id="ydna1_chart1"></div>
      <div id="ydna1_result"></div>
    </div>
    <div class="column">
      <div id="ydna2_buttons"></div>
      <div id="ydna2_chart1"></div>
      <div id="ydna2_result"></div>
    </div>
  </div>

  <hr class="header" style="display:none">

  <div class="row" id="mtdna">
    <h3 class="header" style="display:none">mtDNA Breakdown</h3>
    <div class="column">
      <div id="mtdna1_buttons"></div>
      <div id="mtdna1_chart1"></div>
      <div id="mtdna1_result"></div>
    </div>
    <div class="column">
      <div id="mtdna2_buttons"></div>
      <div id="mtdna2_chart1"></div>
      <div id="mtdna2_result"></div>
    </div>
  </div>

  <hr class="header" style="display:none">

  <div class="row" id="sm">
    <h3 class="header" style="display:none">The Closest Archaeogenetic matches</h3>
    <div class="column">
      <div id="sm1_buttons"></div>
      <div id="sm1_result"></div>
    </div>
    <div class="column">
      <div id="sm2_buttons"></div>
      <div id="sm2_result"></div>
    </div>
  </div>

  <hr class="header" style="display:none">

  <div class="row" id="ddar">
    <h3 class="header" style="display:none">Deep Dive - Ancient Relatives</h3>
    <div class="column">
      <div id="ddar1_buttons"></div>
      <div id="ddar1_result"></div>
    </div>
    <div class="column">
      <div id="ddar2_buttons"></div>
      <div id="ddar2_result"></div>
    </div>
  </div>

   </body>
</html>
