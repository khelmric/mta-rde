<html>
   <meta charset="UTF-8">
   <title>MTA-RDE</title>
   <link rel="icon" type="image/x-icon" href="images/favicon.ico">
   <head>
     <link rel="stylesheet" href="style.css">
   </head>

   <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
   <script src="//unpkg.com/globe.gl"></script>
   <script type="text/javascript">
     google.charts.load('current', {'packages':['table', 'corechart', 'bar']});
   </script>

   <body style="font-family: Arial, Helvetica, sans-serif;">

   <button onclick="topFunction()" id="topButton" title="Go to top">Top</button>

   <h2>MyTrueAncestry - Raw Data Extractor</h3>
   <button onclick="helpEnFunction()">Help (En)</button>
   <button onclick="helpHuFunction()">Help (Hu)</button>
   <button onclick="optionsFunction()" id="viewOptionsButton" disabled="true">View</button>
   <input type='radio' name='languague' id='langEN' checked>
   <label for="langEN">English</label>
   <input type='radio' name='languague' id='langHU'>
   <label for="langHU">Magyar</label>
   <button onClick="window.open('https://github.com/khelmric/mta-rde');">
   <span>Code Repo on Github</span>
   </button>
   <button id="globeButton" onclick="toggleGlobe()">&#127757;&nbsp;&nbsp;Switch to Globe-mode</button>

   <div id="helpEn" style="display:none">
     <section class="fieldset">
       <h1>How to use</h1>
       <ol>
         <li>Login to <a href="https://mytrueancestry.com">https://mytrueancestry.com</a>.</li>
         <li>Select one Kit. (If All Kits are selected only the first will be investigated.)</li>
         <li>Save the webpage in html format.</li>
         <li>On the <a href="https://storage.googleapis.com/atomx-website-mta-rde/index.html">https://storage.googleapis.com/atomx-website-mta-rde/index.html</a> select the html file(s). 
           (Selecting the second file allows a comparsion of two results.)</li>
       </ol>   
     </section>
   </div>
   <div id="helpHu" style="display:none">
     <section class="fieldset">
       <h1>Használati útmutató</h1>
       <ol>
         <li>Jelentkezz be a <a href="https://mytrueancestry.com">https://mytrueancestry.com</a> oldalra.</li>
         <li>Válassz ki egy Kit-et. Az összes Kit kijelölése esetén csak az elsőt vizsgálja a program.</li>
         <li>Mentsd le a weboldalt html formátumban.</li>
         <li>A <a href="https://storage.googleapis.com/atomx-website-mta-rde/index.html">https://storage.googleapis.com/atomx-website-mta-rde/index.html</a> oldalon válaszd ki a html fájlt/fájlokat. 
           (A második fájl kiválasztásával összehasonlítható két különböző eredmény.)</li>
       </ol>
     </section>
   </div>
   <div id="dataModeButtons">
     <div id="viewOptions" style="display:none">
         <br>
         <section class="fieldset">
           <h2>Results</h2>
             <input type="checkbox" id="asb-block" onchange="toggleByClass(this)" checked="true" />
             <label for="showAsb">Ancient Samples Full Breakdown</label><br>
             <input type="checkbox" id="dd-block" onchange="toggleByClass(this)" checked="true" />
             <label for="showDd">Deep Dive Full Breakdown</label><br>
             <input type="checkbox" id="canc-block" onchange="toggleByClass(this)" checked="true" />
             <label for="showCant">Closest Ancient Populations</label><br>
             <input type="checkbox" id="cmod-block" onchange="toggleByClass(this)" checked="true" />
             <label for="showCmod">Closest Modern Populations</label><br>
             <input type="checkbox" id="ydna-block" onchange="toggleByClass(this)" checked="true" />
             <label for="showYdna">Y-DNA Breakdown</label><br>
             <input type="checkbox" id="mtdna-block" onchange="toggleByClass(this)" checked="true" />
             <label for="showMtdna">mtDNA Breakdown</label><br>
             <input type="checkbox" id="sm-block" onchange="toggleByClass(this)" checked="true" />
             <label for="showSm">The Closest Archaeogenetic matches</label><br>
             <input type="checkbox" id="ddar-block" onchange="toggleByClass(this)" checked="true" />
             <label for="showDdar">Deep Dive - Ancient Relatives</label><br>
             <input type="checkbox" id="haploexp-block" onchange="toggleByClass(this)" checked="true" />
             <label for="showHaploexp">All Samples</label><br>
         </section>
         <br>
         <section class="fieldset">
           <h2>Fields</h2>
             <input type="checkbox" id="dl-button" onchange="toggleByClass(this)" checked="true" />
             <label for="showCharts">Buttons</label><br>
             <input type="checkbox" id="result-chart" onchange="toggleByClass(this)" checked="true" />
             <label for="showCharts">Charts</label><br>
             <input type="checkbox" id="result-table" onchange="toggleByClass(this)" checked="true" />
             <label for="showTables">Tables</label><br>
             <input type="checkbox" id="comparison-row" onchange="toggleByClass(this)" checked="true" />
             <label for="showComparison">Comparison</label><br>
         </section>
     </div>
   </div>

  <script>
  //Get the button
  var mybutton = document.getElementById("topButton");

  window.onscroll = function() {scrollFunction()};

  function scrollFunction() {
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
      mybutton.style.display = "block";
    } else {
      mybutton.style.display = "none";
    }
  }

  function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }
  </script>


   <script>
     var colorMap = new Map();
     var arrayAsb1;
     var arrayDd1;
     var arrayYdna1;
     var arrayMtdna1;
     var arrayAsb2;
     var arrayDd2;
     var arrayYdna2;
     var arrayMtdna2;
     var civHu = "Ausztrál őslakos,Andalusz,Alánok,Alemannok,Észak-Amerika bennszülött népei,Amoriták,Ókori egyiptomiak,Ókori görögök,Aquitániaiak,Alaszkai athabaszkaiak,Avarok,Azték Birodalom,Balari,Balti törzsek,Bantu népek,Belga törzsek,Boi,Szindhi Brahmin-dinasztia,Kelta Britonok,Bizánci Birodalom,Kánaániták és szemiták,Kantabriaiak,Karthágóiak,Kelták,Keltibérek,Kelta Brigantesek,Kelta Cantiusok,Kelta Corieltauvi,Kelta Dobunni,Kelta Dumnonii,Kelta Durotriges,Kelta Parisi,Kelta Votadini,Chola-dinasztia,Cimmeriek,Dacians,Daunii,Korai szlávok,Etruszkok,Frankok,Frízek,Gallo-rómaiak,Gallok,Gepidák,Ghaznavid-dinasztia,Görög-Baktri Királyság,Guancsok,Han dinasztia,Hellén rómaiak,Venétek,Hettiták,Hunok,Ősmagyarok,Ibériaiak,Illírek,Inkák,Iolaes,Jomon,Jütök,Karkota Birodalom,Khoisan,Kijevi Rusz,Latinok,Licchavi Királyság,Ligurok,Longobárdok,Luzitánok,Makuriaiak,Markomannok,Maurja Birodalom,Maják,Minósziak,Az Arany Horda,Mórok,Özeliek,Osi törzs,Osztrogótok,Oszmánok,Pannon Illírek,Filiszteusok,Föníciaiak,Piktek,Pontiuszi Birodalom,Pyu Királyságok,Kvádok,Rhaeti,Rómaiak,Római Hispania,Zsuanzsuanok,Rugiak,Safavid-dinasztia,Szakák,Szamniszok,Szarmaták,Szászok,Szkordiszkuszok,Szkíták,Szeleukida Birodalom,Trákok,Türingek,Tokugawa sógunátus,Vandálok,Baszkok,Vikingek,Dán vikingek,Izlandi vikingek,Norvég vikingek,Svéd vikingek,Vizigótok,Yayoi,Joruba népek,Egyéb";
     var civEn = "Aboriginal Australian,Al-Andalus,Alans,Alemanni,Indigenous Peoples of North America,Amorites,Ancient Egyptians,Ancient Greeks,Aquitani,Alaskan Athabaskans,Avars,Aztec Empire,Balari,Baltic Tribes,Bantu Peoples,Belgae,Boii,Brahmin Dynasty of Sindh,Celtic Britons,Byzantine Empire,Canaanites and Semites,Cantabrians,Carthaginians,Celts,Celtiberians,Celtic Brigantes,Celtic Cantiaci,Celtic Corieltavi,Celtic Dobunni,Celtic Dumnonii,Celtic Durotriges,Celtic Parisi,Celtic Votadini,Chola Dynasty,Cimmerians,Dákok,Daunii,Early Slavs,Etruscans,Franks,Frisii,Gallo-Romans,Gauls,Gepids,Ghaznavid Dynasty,Greco-Bactrian Kingdom,Guanches,Han Dynasty,Hellenic Romans,Heneti,Hittites,Huns,Proto-Hungarians,Iberians,Illyrians,Incans,Iolaes,Jomon,Jutes,Karkota Empire,Khoisan,Kievan Rus,Latins,Licchavi Kingdom,Ligurians,Longobards,Lusitanians,Makurian,Marcomanni,Maurya Empire,Mayans,Minoans,The Golden Horde,Moors,Oeselians,Osi Tribe,Ostrogoths,Ottomans,Pannonian Illyrians,Philistines,Phoenicians,Picts,Pontic Empire,Pyu Kingdoms,Quadi,Rhaeti,Romans,Roman Hispania,Rouran Khaganate,Rugii,Safavid Dynasty,Saka,Samnites,Sarmatians,Saxons,Scordisci,Scythians,Seleucid Empire,Thracians,Thuringii,Tokugawa Shogunate,Vandals,Vascones,Vikings,Danish Vikings,Vikings (Icelandic),Norwegian Vikings,Vikings (Swedish),Visigoths,Yayoi,Yoruba Peoples,Other";
     var civHuNames = civHu.split(',');
     var civEnNames = civEn.split(',');
     var gData1Lat = [];
     var gData1Lon = [];
     var gData1Size = [];
     var gData1Text = [];
     var gData1Label = [];
     var gData2Lat = [];
     var gData2Lon = [];
     var gData2Size = [];
     var gData2Text = [];
     var gData2Label = [];
     var gDataDiffLat = [];
     var gDataDiffLon = [];
     var gDataDiffSize = [];
     var gDataDiffText = [];
     var gData1Content;
     var gData2Content;
     var gDataDiffContent;
     var gDataCommonContent;
     var globeImg = "globeDay.jpg";
     var reduceGlobeLabels = 120000;
     var reduceGlobeSpikes = 100000;
     var globeAnimate = false;

     function toggleGlobe() {
       var divGlobe = document.getElementById("globe");
       var divGlobeButtons = document.getElementById("globeButtons");
       var divRawData = document.getElementById("rawData");
       if (divGlobe.style.display === "none") {
         divGlobe.style.display = "block";
         divGlobeButtons.style.display = "block";
         divRawData.style.display = "none";
         document.getElementById("globeButton").innerHTML = "&#128202;&nbsp;&nbsp;Switch to Data-mode";
       } else {
         divGlobe.style.display = "none";
         divGlobeButtons.style.display = "none";
         divRawData.style.display = "initial";
         document.getElementById("globeButton").innerHTML = "&#127757;&nbsp;&nbsp;Switch to Globe-mode";
       }
     }

     function toggleGlobeLabels(checkbox) {
       if (checkbox.checked) {
         reduceGlobeLabels = 120;
       } else {
         reduceGlobeLabels = 120000;
       }
       drawGlobe();
     }

     function toggleGlobeSpikes(checkbox) {
       if (checkbox.checked) {
         reduceGlobeSpikes = 1000;
       } else {
         reduceGlobeSpikes = 100000;
       }
       drawGlobe();
     }

     function animateGlobe(checkbox) {
       if (checkbox.checked) {
         globeAnimate = true;
       } else {
         globeAnimate = false;
       }
       drawGlobe();
     }

     function changeGlobeImg() {
       var globeSelect = document.getElementById("globeImg");
       globeImg = globeSelect.options[globeSelect.selectedIndex].value;
       drawGlobe();
     }

     function getGlobeDataDiff(mode) {
       gDataDiffContent = "";
       gDataCommonContent = "";
       var gData1Diff = gData1Content.replace(/\Genetic[\s\S]*?\<br\>/g, '');
       var gData2Diff = gData2Content.replace(/\Genetic[\s\S]*?\<br\>/g, '');
       eval("var gData1 =[" + gData1Diff + "];");
       eval("var gData2 =[" + gData2Diff + "];");
       if (mode != "diff-kit2") {
         for (var i = 0; i < gData1.length; i++) {
           var matchFound = "false";
           for (var j = 0; j < gData2.length; j++) {
             var gData1Element = JSON.stringify(gData1[i]).replace(/rgba\([\s\S]*?\)/g, 'rgba(150, 0, 150, 0.60)');
             var gData2Element = JSON.stringify(gData2[j]).replace(/rgba\([\s\S]*?\)/g, 'rgba(150, 0, 150, 0.60)');
             if (gData1Element == gData2Element) {
               matchFound = "true";
               gDataCommonContent += gData1Element + ",";
             }
           }
           if (matchFound == "false") {
             gDataDiffContent += JSON.stringify(gData1[i]) + ",";
            }
         }
       }
       if (mode != "diff-kit1") {
         for (var i = 0; i < gData2.length; i++) {
           var matchFound = "false";
           for (var j = 0; j < gData1.length; j++) {
             var gData1Element = JSON.stringify(gData1[j]).replace(/rgba\([\s\S]*?\)/g, 'rgba(150, 0, 150, 0.60)');
             var gData2Element = JSON.stringify(gData2[i]).replace(/rgba\([\s\S]*?\)/g, 'rgba(150, 0, 150, 0.60)');
             if (gData1Element == gData2Element) {
               matchFound = "true";
             }
           }
           if (matchFound == "false") {
             gDataDiffContent += JSON.stringify(gData2[i]) + ",";
           }
         }
       }

       if (mode == "diff" || mode == "diff-kit1" || mode == "diff-kit2") {
         var gDataDiff = "gData = [" + gDataDiffContent + "];";
         eval (gDataDiff);
       } 
       if (mode == "common") {
         var gDataCommon = "gData = [" + gDataCommonContent + "];";
         eval (gDataCommon);
       }
     }

     function changeGlobeData() {
       var globeData = document.getElementById("globeData");
       globeData = globeData.options[globeData.selectedIndex].value;
       if (globeData == "merge") {
         gDataSumContent = "gData = [" + gData1Content + gData2Content + "];";
         eval (gDataSumContent);
       }
       if (globeData == "kit1") {
         gDataSumContent = "gData = [" + gData1Content + "];";
         eval (gDataSumContent);
       }
       if (globeData == "kit2") {
         gDataSumContent = "gData = [" + gData2Content + "];";
         eval (gDataSumContent);
       }
       if (globeData == "diff") {
         getGlobeDataDiff("diff");
       }
       if (globeData == "diff-kit1") {
         getGlobeDataDiff("diff-kit1");
       }
       if (globeData == "diff-kit2") {
         getGlobeDataDiff("diff-kit2");
       }
       if (globeData == "common") {
         getGlobeDataDiff("common");
       }
       drawGlobe();
     }

     function helpHuFunction() {
       var divhelphu = document.getElementById("helpHu");
       var divhelpen = document.getElementById("helpEn");
       var divViewOptions = document.getElementById("viewOptions");
       if (divhelphu.style.display === "none") {
         divhelphu.style.display = "block";
         divViewOptions.style.display = "none";
         divhelpen.style.display = "none"
       } else {
         divhelphu.style.display = "none";
       }
     }
     function helpEnFunction() {
       var divhelphu = document.getElementById("helpHu");
       var divhelpen = document.getElementById("helpEn");
       var divViewOptions = document.getElementById("viewOptions");
       if (divhelpen.style.display === "none") {
         divhelpen.style.display = "block";
         divViewOptions.style.display = "none";
         divhelphu.style.display = "none"
       } else {
         divhelpen.style.display = "none";
       }
     }
     function optionsFunction() {
       var divhelphu = document.getElementById("helpHu");
       var divhelpen = document.getElementById("helpEn");
       var divViewOptions = document.getElementById("viewOptions");
       if (divViewOptions.style.display === "none") {
         divViewOptions.style.display = "block";
         divhelpen.style.display = "none";
         divhelphu.style.display = "none"
       } else {
         divViewOptions.style.display = "none";
       }
     }

    function toggleByClass(checkbox) {
      var displaySetting = "";
      if (checkbox.checked) {
        displaySetting = "block";
      } else {
        displaySetting = "none";
      }
      var targets = document.getElementsByClassName(checkbox.id);
      for(var i = 0; i < targets.length; ++i){
        targets[i].style.display = displaySetting;
      }
    }

    function chartDataTransform(textContent, mREGEX, sREGEX) {
      textContent = textContent.match(mREGEX);
      textContent = String(textContent);
      textContent = textContent.match(sREGEX);
      textContent = String(textContent);
      REGEX = /\"\s?\,\s?\"/g;
      textContent = textContent.replace(REGEX, ',');
      textContent = String(textContent);
      REGEX = /[\s\S]*?\[|\]|\"/g;
      textContent = textContent.replace(REGEX, '');
      textContent = String(textContent);
      return textContent;
    }

    function listSmallDataTransform(textContent, mREGEX, sREGEX1, sREGEX2, sREGEX3, sREGEX4, sREGEX5) {
      textContent = textContent.match(mREGEX);
      textContent = String(textContent);
      textContent = textContent.replace(/\s+\+\s+/g, '+');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX1, '');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX2, ';');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX3, ',');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX4, ' ');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX5, '');
      textContent = String(textContent);
      return textContent;
    }  

    function listDataTransform(textContent, matchNo, mREGEX, sREGEX1, sREGEX2, sREGEX3, sREGEX4, sREGEX5, sREGEX6) {
      textContent = textContent.match(mREGEX);
      textContent = String(textContent[matchNo]);
      textContent = textContent.matchAll(sREGEX1);
      textContent = Array.from(textContent);
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX2, '');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX3, ';');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX4, ',');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX5, '');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX6, ',');
      textContent = String(textContent);
      return textContent;
    }

    function listBigDataTransform(textContent, mREGEX, sREGEX1, sREGEX2, sREGEX3, sREGEX4, sREGEX5) {
      textContent = textContent.match(mREGEX);
      textContent = String(textContent);
      textContent = textContent.match(sREGEX1);
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX2, '');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX3, '');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX4, '');
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX5, ',');
      textContent = String(textContent);
      return textContent;
    }

    function getKitData(textContent, target, mREGEX, sREGEX1) {
      textContent = textContent.match(mREGEX);
      textContent = String(textContent);
      textContent = textContent.replace(sREGEX1, '');
      textContent = String(textContent);
      kitContent = textContent.split('"');
      targetNameDiv = document.getElementById(target + '_name');
      targetNumberDiv = document.getElementById(target + '_number');
      targetNameDiv.innerHTML = kitContent[1];
      targetNumberDiv.innerHTML = kitContent[0];
      return kitContent[0];
    }

    function getKitDate(textContent, kitNumber, target) {
      var mREGEX = new RegExp('info_[\\S]*?_' + kitNumber + '[\\s\\S]*?Processed[\\s\\S]*?\\)', "");
      textContent = textContent.match(mREGEX);
      textContent = String(textContent);
      textContent = textContent.replace(/[\s\S]*?Processed/, '');
      textContent = String(textContent);
      textContent = textContent.replace(/\([\s\S]*?\)/, '');
      textContent = String(textContent);
      targetDiv = document.getElementById(target + '_date');
      targetDiv.innerHTML = textContent;
    }

    function printChartAsTable(textContent, mainREGEX, subREGEX1, subREGEX2, subREGEX3, target, col) {

      var dataArray = [];

      chartLabels = chartDataTransform(textContent, mainREGEX, subREGEX1);
      chartLabelArray = chartLabels.split(',');

      targetDiv = target + col;
      tableDivId = document.getElementById(targetDiv + '_result');
      chart1DivId = document.getElementById(targetDiv + '_chart1');
      buttonsDivId = document.getElementById(targetDiv + '_buttons');

      chartData = chartDataTransform(textContent, mainREGEX, subREGEX2);
      chartDataArray = chartData.split(',');

      chartBgColor = chartDataTransform(textContent, mainREGEX, subREGEX3);
      chartBgColorArray = chartBgColor.split(',');
      var data = new google.visualization.DataTable();

      data.addColumn('string', 'Description');
      data.addColumn('number', 'Value');
      data.addColumn('string', 'Color');

      for (var i = 0; i < chartLabelArray.length; i++) {
        var dataValueAsInt = chartDataArray[i].replace(/\s?/g, '');
        if ( dataValueAsInt.search( /\./ ) == 2) {
          dataValueAsInt = dataValueAsInt + '0';
        }
        dataValueAsInt = parseInt(dataValueAsInt.replace(/\./, ''));

        if(document.getElementById('langHU').checked) {
          var chartLabel = civHuNames[civEnNames.indexOf(chartLabelArray[i])];
        } else {
          var chartLabel = chartLabelArray[i];
        }

        if (chartLabel == null || chartLabel == 'undefined') {
          chartLabel = chartLabelArray[i];
        }

        dataArray[i] = [];
        dataArray[i][0] = chartLabel;
        dataArray[i][1] = chartDataArray[i];
        dataArray[i][2] = dataValueAsInt;
        dataArray[i][3] = chartBgColorArray[i];
        colorMap.set(chartLabel, chartBgColorArray[i]);

        var rowContent = 'data.addRow([{v: "' + chartLabel + '", f: "' + chartLabel +  ' (' + chartDataArray[i] + '%)"}, {v: ' + dataValueAsInt + ', f: "' + chartDataArray[i] + '"}, {v: "' + chartBgColorArray[i] + '", f: null, p: {style: "background-color: ' + chartBgColorArray[i] + ';"}}]);';
        eval(rowContent);
      }
      var table = new google.visualization.Table(tableDivId);
      table.draw(data, {showRowNumber: false, width: '100%', height: '100%', allowHtml: true});
 
      var chart1 = new google.visualization.PieChart(chart1DivId);
      chart1.draw(data, {
          width: '900', 
          height: '400',
          colors: chartBgColorArray,
          is3D: true,
          chartArea: {
            height: '96%'
          },
          legend: {
            textStyle: {
              fontSize: 10
            }
          }
      });

      // Prepare and display download buttons
      var csvContent = google.visualization.dataTableToCsv(data);
      var csvData = new Blob([csvContent]);
      buttonsDivId.innerHTML = '<a href=\"' + chart1.getImageURI() + '\" download=\"chart.png\"> <button type=\"button\">\&\#8681\; .png</button></a>' + '<a href=\"' + URL.createObjectURL(csvData) + '\" download=\"data.csv\" type=\"text/csv\"><button type=\"button\">\&\#8681\; .csv</button></a>';

      return dataArray;
    }

    function printSmallListAsTable(textContent, mainREGEX, subREGEX1, subREGEX2, subREGEX3, subREGEX4, subREGEX5, target, tableHeader) {
      listContent = listSmallDataTransform(textContent, mainREGEX, subREGEX1, subREGEX2, subREGEX3, subREGEX4, subREGEX5);
      listContentLineArray = listContent.split(';');

      var data = new google.visualization.DataTable();

      tableDivId = document.getElementById(target + '_result');
      buttonsDivId = document.getElementById(target + '_buttons');

      headersArray = tableHeader.split(',');
      for (var i = 0; i < headersArray.length; i++) {
        data.addColumn('string', headersArray[i]);
      }

      for (var i = 0; i < listContentLineArray.length-1; i++) {        
        listContentElementArray = listContentLineArray[i].split(',');
        var rowContent = "";
        for (var j = 0; j < listContentElementArray.length; j++) {
          cleanVar = listContentElementArray[j].replace(/\<br\>|\'/g, '');
          if (rowContent) {
            rowContent += ", '" + cleanVar + "'";
          } else {
            rowContent = "data.addRow(['" + cleanVar + "'";
          }
        }
        rowContent += "]);";
        eval(rowContent);
      }
      var table = new google.visualization.Table(tableDivId);
      table.draw(data, {showRowNumber: false, width: '100%', height: '100%', allowHtml: true});

      // Prepare and display download buttons
      var csvContent = google.visualization.dataTableToCsv(data);
      var csvData = new Blob([csvContent]);
      buttonsDivId.innerHTML = '<a href=\"' + URL.createObjectURL(csvData) + '\" download=\"data.csv\" type=\"text/csv\"><button type=\"button\">\&\#8681\; .csv</button></a>';

    }

    function printBigListAsTable(textContent, arrayNamesText, mainREGEX, subREGEX2, subREGEX3, subREGEX4, subREGEX5, target, tableHeader) {
      arrayNames = arrayNamesText.split(',');

      for (var i = 0; i < arrayNames.length; i++) {
        var subREGEX1 = new RegExp(arrayNames[i] + '\=\{[\\s\\S]*?\}', "");
        listContent = listBigDataTransform(textContent, mainREGEX, subREGEX1, subREGEX2, subREGEX3, subREGEX4, subREGEX5);
        listContentLineArray[i] = listContent.split(',');
      }

      var data = new google.visualization.DataTable();

      tableDivId = document.getElementById(target + '_result');
      buttonsDivId = document.getElementById(target + '_buttons');

      headersArray = tableHeader.split(',');
      for (var i = 0; i < headersArray.length; i++) {
        data.addColumn('string', headersArray[i]);
      }

        for (var j = 0; j < listContentLineArray[0].length; j++) {
        var rowContent = "";
          for (var k = 0; k < headersArray.length; k++) {
            cleanVar = listContentLineArray[k][j].replace(/\<br\>|\'/g, '');
            if (rowContent) {
              rowContent += ", '" + cleanVar + "'";
            } else {
              rowContent = "data.addRow(['" + cleanVar + "'";
            }
          }
        rowContent += "]);";
        eval(rowContent);
        }

      var table = new google.visualization.Table(tableDivId);
      table.draw(data, {showRowNumber: true, width: '100%', height: '100%', allowHtml: true});

      // Prepare and display download buttons
      var csvContent = google.visualization.dataTableToCsv(data);
      var csvData = new Blob([csvContent]);
      buttonsDivId.innerHTML = '<a href=\"' + URL.createObjectURL(csvData) + '\" download=\"data.csv\" type=\"text/csv\"><button type=\"button\">\&\#8681\; .csv</button></a>';
    }

    function printListAsTable(textContent, matchNo, mainREGEX, subREGEX1, subREGEX2, subREGEX3, subREGEX4, subREGEX5, subREGEX6, target, tableHeader) {
      listContent = listDataTransform(textContent, matchNo, mainREGEX, subREGEX1, subREGEX2, subREGEX3, subREGEX4, subREGEX5, subREGEX6);
      listContentLineArray = listContent.split(';');

      var data = new google.visualization.DataTable();

      tableDivId = document.getElementById(target + '_result');
      buttonsDivId = document.getElementById(target + '_buttons');
 
      headersArray = tableHeader.split(',');
      for (var i = 0; i < headersArray.length; i++) {
        data.addColumn('string', headersArray[i]);
      }

      for (var i = 0; i < listContentLineArray.length-1; i++) {
        listContentElementArray = listContentLineArray[i].split(',');
        var rowContent = "";
        for (var j = 0; j < listContentElementArray.length; j++) {
          cleanVar = listContentElementArray[j].replace(/\<br\>|\'/g, '');
          if (rowContent) {
            rowContent += ", '" + cleanVar + "'";
          } else {
            rowContent = "data.addRow(['" + cleanVar + "'";
          }
        }
        rowContent += "]);";
        eval(rowContent);
      }
      var table = new google.visualization.Table(tableDivId);
      table.draw(data, {showRowNumber: false, width: '100%', height: '100%', allowHtml: true});

      // Prepare and display download buttons
      var csvContent = google.visualization.dataTableToCsv(data);
      var csvData = new Blob([csvContent]);
      buttonsDivId.innerHTML = '<a href=\"' + URL.createObjectURL(csvData) + '\" download=\"data.csv\" type=\"text/csv\"><button type=\"button\">\&\#8681\; .csv</button></a>';
    }

    function indexOfArray(array2d, itemtofind) {
      var row;
      var searchTest = "'" + itemtofind + "',";
      for (var i = 0; i < array2d.length; i++) {
        if (array2d[i].includes(itemtofind)) {
          row = i;
        }
      }
      row = parseInt(row);
      return row;
    }

    function printDiffPieChart(dataArray1, dataArray2, target) {
      if (dataArray1 !== null && dataArray2 !== null && typeof dataArray1 !== 'undefined' && typeof dataArray2 !== 'undefined') {
      chartDivId = document.getElementById(target + '_chart');
      chartDivAnnotationId = target + '_chart_annotation';
      buttonsDivId = document.getElementById(target + '_buttons');

        var kit1name = document.getElementById('kit1_name');
        var kit1date = document.getElementById('kit1_date');
        var kit2name = document.getElementById('kit2_name');
        var kit2date = document.getElementById('kit2_date');
        kit1date = String(kit1date.textContent);
        var kit1dateShort = kit1date.replace(/[\S]*?[\s]?$/,'');
        kit2date = String(kit2date.textContent);
        var kit2dateShort = kit2date.replace(/[\S]*?[\s]?$/,'');

        var label1 = kit1name.textContent + kit1dateShort;
        var label2 = kit2name.textContent + kit2dateShort;

        var chartData1 = "['Name','Value']";
        var chartData2 = "['Name','Value']";
        var row = ""
        var chartArray1 =[];
        var chartArray2 =[];
        var notFoundInData1 = [];
        var notFoundInData2 = [];

        for (var i = 0; i < dataArray1.length; i++) {
          var foundData2Match = false;
          for (var j = 0; j < dataArray2.length; j++) {
            if ( dataArray2[j].includes(dataArray1[i][0]) && (foundData2Match == false)) {
              foundData2Match = true;
            }
          }
          chartArray1.push("['" + dataArray1[i][0] + "', " + dataArray1[i][2] / 100 + "]");
          if ( foundData2Match == false ) {
             chartArray2.push("['" + dataArray1[i][0] + "', 0]");
          }
        }

        for (var i = 0; i < dataArray2.length; i++) {
          var foundData1Match = false;
          for (var j = 0; j < dataArray1.length; j++) {
            if ( dataArray1[j].includes(dataArray2[i][0]) && (foundData1Match == false)) {
              foundData1Match = true;
            }
          }
          chartArray2.push("['" + dataArray2[i][0] + "', " + dataArray2[i][2] / 100 + "]");
          if ( foundData1Match == false ) {
             chartArray1.push("['" + dataArray2[i][0] + "', 0]");
          }
        }

        chartData1 += notFoundInData1;
        chartData2 += notFoundInData2;

//        chartArray1.sort();
//        chartArray2.sort();
        var colorArray = "";
        for (var i = 0; i < chartArray1.length; i++) {
          var civName = chartArray1[i];
          civName = String(civName);
          civName = civName.replace(/^[\s\S]*?\'/, '');
          civName = String(civName);
          civName = civName.replace(/\'[\s\S]*?$/, '');
          civName = String(civName);
          if ( i < chartArray1.length-1 ) {
            colorArray += "'" + colorMap.get(civName).toLowerCase() + "', ";
          } else {
            colorArray += "'" + colorMap.get(civName).toLowerCase() + "'";
          }

          // Add values to label
          var index = indexOfArray(chartArray2,civName);
          var chartData1Value = chartArray1[i].replace(/^[\s\S]*?\,\ /, '');
          chartData1Value = String(chartData1Value);
          chartData1Value = chartData1Value.replace(/]/, '');
          chartData1Value = String(chartData1Value);
          var chartData2Value = chartArray2[index].replace(/^[\s\S]*?\,\ /, '');
          chartData2Value = String(chartData2Value);
          chartData2Value = chartData2Value.replace(/]/, '');
          chartData2Value = String(chartData2Value);

          var chartDataValues1 = " [" + chartData1Value + "%, " + chartData2Value + "%]";
          var chartDataValues2 = " [" + chartData1Value + "%, " + chartData2Value + "%]";
          var tempChartData1 = chartArray1[i].replace(/\'\,/,chartDataValues1 + "\'\,");
          var tempChartData2 = chartArray2[index].replace(/\'\,/,chartDataValues2 + "\'\,");

          chartData1 += "," + tempChartData1;
          chartData2 += "," + tempChartData2;

        }
        colorArray = '[' + colorArray + ']';
        eval ("var oldData = google.visualization.arrayToDataTable([" + chartData1 + "])");
        eval ("var newData = google.visualization.arrayToDataTable([" + chartData2 + "])");

            var options = {
               pieSliceText: 'none',
               sliceVisibilityThreshold: 0,
               colors: eval(colorArray),
               diff: {
                 oldData: {
                   opacity: 1,
                   tooltip:{
                     prefix: ' '
                   }
                 },
                 newData: {
                   opacity: 1,
                   widthFactor: 1,
                   tooltip:{
                     prefix: '  '
                   }
                 },
                 innerCircle: { 
                   borderFactor: 0.05
                 }
               },
               width: '900',
               height: '780',
               is3D: true,
               fontSize: 11,
            };

            var chartDiff = new google.visualization.PieChart(chartDivId);
            var diffData = chartDiff.computeDiff(newData, oldData);
            chartDiff.draw(diffData, options);

//            var chartDiff = new google.visualization.BarChart(chartDivId);
//            var diffData = chartDiff.computeDiff(data1, data2);
//            chartDiff.draw(diffData, options);
      // Draw lines and labels
      var canvas = document.getElementById(chartDivAnnotationId);
      var annotationCanvas = canvas.getContext("2d");
      annotationCanvas.clearRect(0, 0, canvas.width, canvas.height);
      annotationCanvas.font = "12px Arial";
      annotationCanvas.fillText(label1,42,20);
      annotationCanvas.moveTo(40,20);
      annotationCanvas.lineTo(0,60);
      annotationCanvas.stroke();
      annotationCanvas.font = "12px Arial";
      annotationCanvas.fillText(label2,42,40);
      annotationCanvas.moveTo(40,40);
      annotationCanvas.lineTo(0,128);
      annotationCanvas.stroke();
      // Prepare and display download buttons
      buttonsDivId.innerHTML = '<a href=\"' + chartDiff.getImageURI() + '\" download=\"chart.png\"> <button type=\"button\">\&\#8681\; .png</button></a>'

      }
    }


    function printComboChart(dataArray1, dataArray2, target) {
      if (dataArray1 !== null && dataArray2 !== null && typeof dataArray1 !== 'undefined' && typeof dataArray2 !== 'undefined') {
      chartDivId = document.getElementById(target + '_chart');
      buttonsDivId = document.getElementById(target + '_buttons');

        var kit1name = document.getElementById('kit1_name');
        var kit1date = document.getElementById('kit1_date');
        var kit2name = document.getElementById('kit2_name');
        var kit2date = document.getElementById('kit2_date');
        var chartData = "['Name','" + kit1name.textContent + "-" + kit1date.textContent + "', '" + kit2name.textContent + "-" + kit2date.textContent + "']";
        var row = "";

        var foundInData1 = [];
        for (var i = 0; i < dataArray1.length; i++) {
          var foundData2Match = false;
          for (var j = 0; j < dataArray2.length; j++) {
            if ( dataArray2[j].includes(dataArray1[i][0]) && (foundData2Match == false)) {
              const matchingData = (element) => element == dataArray1[i][0];
              var data2index = dataArray2[j].findIndex(matchingData);
              chartData += ",['" + dataArray1[i][0] + "', " + dataArray1[i][2] / 100 + ", " + dataArray2[j][2] / 100 + "]";
              foundData2Match = true;
              foundInData1[j] = true;
            }
          }
          if ( foundData2Match == false ) {
             chartData += ",['" + dataArray1[i][0] + "', " + dataArray1[i][2] / 100 + ", 0]";          
          }
        }
        for (var i = 0; i < dataArray2.length; i++) {
          if (foundInData1[i] == null || typeof foundInData1[i] == 'undefined') {
            chartData += ",['" + dataArray2[i][0] + "', 0, " + dataArray2[i][2] / 100 + "]";
          }
        }
      
        eval ("var data = google.visualization.arrayToDataTable([" + chartData + "])");

            var options = {
               orientation:'vertical',
               vAxis: { showTextEvery:1 },
               seriesType: 'bars',
               width: '900',
               height: '650',
               fontSize: 11,
               chartArea: {
                 height: '86%'
               },
            };

            var chart = new google.visualization.ComboChart(chartDivId);
            chart.draw(data, options);

      // Prepare and display download buttons
      buttonsDivId.innerHTML = '<a href=\"' + chart.getImageURI() + '\" download=\"chart.png\"> <button type=\"button\">\&\#8681\; .png</button></a>'

      }
    }
 
    async function openFileFunction(event,col) {
      // define arrays
      var arrayAsb = [];
      var arrayDd = [];
      var arrayYdna = [];
      var arrayMtdna = [];

      for (let el of document.querySelectorAll('.header')) el.style.display = 'block';
      document.getElementById('viewOptionsButton').disabled = false;
      const selectedFile = event.target.files.item(0);
      textContent = await selectedFile.text();

      // Get Kit info from html text
      if (col == 1) {
        kitDivInfo="kit1";
      } else {
        kitDivInfo="kit2";
      }
      mainREGEXkit=/Kit\:.*show.*\<\/a\>/;
      subREGEX1kit=/.*id\=\"name|\ onclick[\s\S]*?\>|\<\/a\>/g;
      var kitNumber = getKitData(textContent, kitDivInfo, mainREGEXkit, subREGEX1kit);
      getKitDate(textContent, kitNumber, kitDivInfo);

      // Update globe data select with kit info
        if (col == 1) {
          var kit1name = document.getElementById('kit1_name');
          var kit1date = document.getElementById('kit1_date');
          document.getElementById("globeData-kit1").innerHTML = kit1name.textContent + " - " + kit1date.textContent;
        } else {
          var kit2name = document.getElementById('kit2_name');
          var kit2date = document.getElementById('kit2_date');
          document.getElementById("globeData-kit2").innerHTML = kit2name.textContent + " - " + kit2date.textContent;
        }

      // Get ASB, DD, Y-DNA and mtDNA data from html text
      var mainREGEXasb = new RegExp('refreshFunctionChartAncient' + kitNumber + '\\(jobid\\) \\{[\\s\\S]*?\\}', "g");
      var mainREGEXdd =  new RegExp('refreshFunctionChartDDAncient' + kitNumber + '\\(jobid\\) \{[\\s\\S]*?\\}', "g");
      var mainREGEXydna = new RegExp('refreshFunctionChart' + kitNumber + '\\(job[\\s\\S]*?options', "g");
      var mainREGEXmtdna = new RegExp('\\#pieChartYData' + kitNumber + '[\\s\\S]*?document.getElementById\\(\\"pieChartX[\\s\\S]*?\\{[\\s\\S]*?\\}', "g");
      subREGEX1=/labels[\s\S]*?\]/g;
      subREGEX2=/data[\s\S]*?\]/g;
      subREGEX3=/backgroundColor[\s\S]*?\]/g;

      // Print Charts and Tables
      if (col == 1) {
        arrayAsb1 = printChartAsTable(textContent, mainREGEXasb, subREGEX1, subREGEX2, subREGEX3, "asb", col);
        arrayDd1 = printChartAsTable(textContent, mainREGEXdd, subREGEX1, subREGEX2, subREGEX3, "dd", col);
        arrayYdna1 = printChartAsTable(textContent, mainREGEXydna, subREGEX1, subREGEX2, subREGEX3, "ydna", col);
        arrayMtdna1 = printChartAsTable(textContent, mainREGEXmtdna, subREGEX1, subREGEX2, subREGEX3, "mtdna", col);
      } else {
        arrayAsb2 = printChartAsTable(textContent, mainREGEXasb, subREGEX1, subREGEX2, subREGEX3, "asb", col);
        arrayDd2 = printChartAsTable(textContent, mainREGEXdd, subREGEX1, subREGEX2, subREGEX3, "dd", col);
        arrayYdna2 = printChartAsTable(textContent, mainREGEXydna, subREGEX1, subREGEX2, subREGEX3, "ydna", col);
        arrayMtdna2 = printChartAsTable(textContent, mainREGEXmtdna, subREGEX1, subREGEX2, subREGEX3, "mtdna", col);
      } 

      // Print Diff-Charts
      printDiffPieChart (arrayAsb1, arrayAsb2, "asb_diffpie");
      printDiffPieChart (arrayDd1, arrayDd2, "dd_diffpie");
      printDiffPieChart (arrayYdna1, arrayYdna2, "ydna_diffpie");
      printDiffPieChart (arrayMtdna1, arrayMtdna2, "mtdna_diffpie");

      // Print Comparison Charts and Tables
      printComboChart (arrayAsb1, arrayAsb2, "asb_combo");
      printComboChart (arrayDd1, arrayDd2, "dd_combo");
      printComboChart (arrayYdna1, arrayYdna2, "ydna_combo");
      printComboChart (arrayMtdna1, arrayMtdna2, "mtdna_combo");

      var mainREGEXsm = new RegExp('refreshFunctionGlobeHaplo' + kitNumber + '\\(samplemax\\) \\{[\\s\\S]*?\]\\;', "g");
      subREGEX1sm=/title[\s\S]*?\,/g;
      subREGEX2sm=/title\"\:\s?\"Sample\s?match\s?\#/g;
      subREGEX3sm=/\"\,\,|\"\,/g;
      subREGEX4sm=/Y-DNA\:\s?|mtDNA\:\s?|Age\:\s?|Genetic\s?Distance\:\s?|Archaeological\s?ID\:\s?/g;
      subREGEX5sm=/\r*|\n*/g;
      subREGEX6sm=/\:/g;
      smMatchNo=0;
      smTableHeader="No,Name,Y-DNA,mtDNA,Age,GD,Arch ID";

      mainREGEXddar=/dataDD\=\[[\s\S]*?\]\;/g;
      subREGEX1ddar=/title[\s\S]*?\,/g;
      subREGEX2ddar=/title\"\:\s?\"Deep\s?Dive\s?match\:/g;
      subREGEX3ddar=/\"\,\,|\"\,/g;
      subREGEX4ddar=/Y-DNA\:\s?|mtDNA\:\s?|Age\:\s?|Longest\s?Shared\s?DNA\:\s?|Archaeological\s?ID\:\s?/g;
      subREGEX5ddar=/\r*|\n*/g;
      subREGEX6ddar=/\:/g;
      ddarMatchNo=1;
      ddarTableHeader="Name,Y-DNA,mtDNA,Age,Longest Shared DNA,Arch ID";

      mainREGEXcmod=/Your\s?closest\s?genetic\s?modern[\s\S]*?\<hr\>/;
      subREGEX1cmod=/Your\s?closest[\s\S]*?\<\/a\>|\<hr\>|\<br\>|\n/g;
      subREGEX2cmod=/\)/g;
      subREGEX3cmod=/\s+\(/g;
      subREGEX4cmod=/\_/g;
      subREGEX5cmod=/\(|^,|,$/g;
      cmodTableHeader="Name,GD";

      mainREGEXcanc=/Your\s?closest\s?Ancient\s?populations[\s\S]*?\<a/;
      subREGEX1canc=/Your\s?closest[\s\S]*?\<\/div\>\<\/div\>\<hr\>|\<br\>|\<\/font\>|\<font\s?color\=\"[\S]{6}\"\>|\<a|\n/g;
      subREGEX2canc=/\)/g;
      subREGEX3canc=/\s+\(/g;
      subREGEX4canc=/\_/g;
      subREGEX5canc=/\(|^,|,$|\s+/g;
      cancTableHeader="Name,GD";

      var mainREGEXhaploExp = new RegExp('document.getElementById\\(\\"nav-haploexpYdd-tab' + kitNumber + '[\\s\\S]*?function processData\\(data\\) \\{', "");
      arrayListHaploExp = 'name_map,age_map,score_map,arch_map,y_map,x_map';
      haploExpHeader = "Name,Age,Score,Arch,Y-DNA,mtDNA";
      subREGEXhaploExp2 = /\}\;[\s\S]*?/g; // to remove
      subREGEXhaploExp3 = /Y-DNA\:\s?|mtDNA\:\s?|[\S]*?\"\:\"/g; // to remove
      subREGEXhaploExp4 = /\"|\}/g; // to remove
      subREGEXhaploExp5 = /\,\s*/g; // to replace with comma
       

      if (col == 1) {
        printSmallListAsTable(textContent, mainREGEXcanc, subREGEX1canc, subREGEX2canc, subREGEX3canc, subREGEX4canc, subREGEX5canc, "canc1", cancTableHeader);
        printSmallListAsTable(textContent, mainREGEXcmod, subREGEX1cmod, subREGEX2cmod, subREGEX3cmod, subREGEX4cmod, subREGEX5cmod, "cmod1", cmodTableHeader);
        printListAsTable(textContent, smMatchNo, mainREGEXsm, subREGEX1sm, subREGEX2sm, subREGEX3sm, subREGEX4sm, subREGEX5sm, subREGEX6sm, "sm1", smTableHeader);
        printListAsTable(textContent, ddarMatchNo, mainREGEXddar, subREGEX1ddar, subREGEX2ddar, subREGEX3ddar, subREGEX4ddar, subREGEX5ddar, subREGEX6ddar, "ddar1", ddarTableHeader);
        printBigListAsTable(textContent, arrayListHaploExp, mainREGEXhaploExp, subREGEXhaploExp2, subREGEXhaploExp3, subREGEXhaploExp4, subREGEXhaploExp5, "haploexp1", haploExpHeader);
      } else {
        printSmallListAsTable(textContent, mainREGEXcanc, subREGEX1canc, subREGEX2canc, subREGEX3canc, subREGEX4canc, subREGEX5canc, "canc2", cancTableHeader);
        printSmallListAsTable(textContent, mainREGEXcmod, subREGEX1cmod, subREGEX2cmod, subREGEX3cmod, subREGEX4cmod, subREGEX5cmod, "cmod2", cmodTableHeader);
        printListAsTable(textContent, smMatchNo, mainREGEXsm, subREGEX1sm, subREGEX2sm, subREGEX3sm, subREGEX4sm, subREGEX5sm, subREGEX6sm, "sm2", smTableHeader);
        printListAsTable(textContent, ddarMatchNo, mainREGEXddar, subREGEX1ddar, subREGEX2ddar, subREGEX3ddar, subREGEX4ddar, subREGEX5ddar, subREGEX6ddar, "ddar2", ddarTableHeader);
        printBigListAsTable(textContent, arrayListHaploExp, mainREGEXhaploExp, subREGEXhaploExp2, subREGEXhaploExp3, subREGEXhaploExp4, subREGEXhaploExp5, "haploexp2", haploExpHeader);
      }

      prepareGlobe(textContent,col);

    }

    function prepareGlobe(textContent,col) {

        if (col == 1) {
         gData1Content = " ";
        } else {
         gData2Content = " ";
        }

        textContent = textContent.match(/refreshFunctionGlobe.?\(samplemax\)[\s\S]*?\]\;/);
        textContent = String(textContent);
        textContent = textContent.replace(/^[\s\S]*?data2\=/g, '');
        textContent = String(textContent);        
        textContent = textContent.split('}');
        for (var i = 0; i < textContent.length; i++) {
          geoAttributes = textContent[i].split(',');
          for (var j = 0; j < geoAttributes.length; j++) {
            if (geoAttributes[j].includes("latitude")) {
              if (col == 1) {
                gData1Lat[i] = geoAttributes[j].replace(/^[\s\S]*?\ /g, '');
              } else {
                gData2Lat[i] = geoAttributes[j].replace(/^[\s\S]*?\ /g, '');
              }
            }
            if (geoAttributes[j].includes("longitude")) {
              if (col == 1) {
                gData1Lon[i] = geoAttributes[j].replace(/^[\s\S]*?\ /g, '');
              } else {
                gData2Lon[i] = geoAttributes[j].replace(/^[\s\S]*?\ /g, '');
              }
            }
            if (geoAttributes[j].includes("cradius")) {
              if (col == 1) {
                gData1Size[i] = parseInt(geoAttributes[j].replace(/^[\s\S]*?\ /g, '')) * 8;
              } else {
                gData2Size[i] = parseInt(geoAttributes[j].replace(/^[\s\S]*?\ /g, '')) * 8;
              }
            }
            if (geoAttributes[j].includes("title")) {
              var divBegin = '"<div style=\'position: relative; z-index: 4; min-width: 108px; padding: 10px 14px;color: #000000; background: #FFFFFF;border: 1px solid #E5E5E5;box-shadow: 0px 2px 20px rgba(32, 32, 35, 0.13);border-radius: 4px;\'>';
              var divEnd = '</div>"';
              if (col == 1) {
                gData1Text[i] = geoAttributes[j].replace(/^[\s\S]*?\:\<br\>/g, '');
                gData1Text[i] = gData1Text[i].replace(/\"/g, '');
                gData1Text[i] = divBegin + gData1Text[i] + divEnd;
                gData1Label[i] = geoAttributes[j].replace(/^[\s\S]*?\:\<br\>/g, '');
                gData1Label[i] = gData1Label[i].replace(/\<br\>Age\:\ /g, ' ');
                gData1Label[i] = gData1Label[i].replace(/\<br\>Genetic[\s\S]*?ID\:\ /g, ' (');
                gData1Label[i] = gData1Label[i].replace(/\"[\s\S]*?$/g, ')');
                
              } else {
                gData2Text[i] = geoAttributes[j].replace(/^[\s\S]*?\:\<br\>/g, '');
                gData2Text[i] = gData2Text[i].replace(/\"/g, '');
                gData2Text[i] = divBegin + gData2Text[i] + divEnd;
                gData2Label[i] = geoAttributes[j].replace(/^[\s\S]*?\:\<br\>/g, '');
                gData2Label[i] = gData2Label[i].replace(/\<br\>Age\:\ /g, ' ');
                gData2Label[i] = gData2Label[i].replace(/\<br\>Genetic[\s\S]*?ID\:\ /g, ' (');
                gData2Label[i] = gData2Label[i].replace(/\"[\s\S]*?$/g, ')');
              }
            }
          }
        }

        if (typeof gData1Content == 'undefined') {
          gData1Content = " ";
        }
        if (typeof gData2Content == 'undefined') {
          gData2Content = " ";
        }

        if (col == 1) {
          for (var i = 0; i < gData1Size.length; i++) {
            gData1Content += " { name: " + gData1Text[i] + ", label: '" + gData1Label[i] + "', lat: " + gData1Lat[i] + ", lng: " + gData1Lon[i] + ", size: " + gData1Size[i] + ", color: 'rgba(0, 0, 255, 0.60)'},";
          }
        } else {
          for (var i = 0; i < gData2Size.length; i++) {
            gData2Content += " { name: " + gData2Text[i] + ", label: '" + gData2Label[i] + "',lat: " + gData2Lat[i] + ", lng: " + gData2Lon[i] + ", size: " + gData2Size[i] + ", color: 'rgba(255, 0, 0, 0.60)'},";
          }
        }

        gDataSumContent = "gData = [" + gData1Content + gData2Content + "];";
        eval (gDataSumContent);
        changeGlobeData();

    }


    function drawGlobe() {
        const markerSvg = `<svg viewBox="-4 0 36 36">
          <circle fill="currentColor" cx="14" cy="14" r="7"></circle>
        </svg>`;
      var imgUrl= "'globes/" + globeImg + "'";
      const world = Globe()
        .globeImageUrl(eval(imgUrl))
        .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
//        .htmlElementsData(gData)
//        .htmlElement(d => {
//          const el = document.createElement('div');
//          el.innerHTML = markerSvg;
//          el.style.color = d.color;
//          el.style.width = `${d.size}px`;
//          el.style['pointer-events'] = 'auto';
//          el.style.cursor = 'pointer';
//          el.onclick = () => console.info(d);
//          return el;
//        })
        .pointsData(gData)
        .pointLabel(d => d.name)
        .pointLat(d => d.lat)
        .pointLng(d => d.lng)
        .pointRadius(d => d.size / 80)
        .pointColor(d => d.color)
        .pointAltitude(d => d.size / reduceGlobeSpikes)
        .labelsData(gData)
        .labelLat(d => d.lat)
        .labelLng(d => d.lng)
        .labelSize(d => d.size / reduceGlobeLabels)
        .labelText(d => d.label)
        .labelColor(() => 'rgba(0, 0, 0, 100.0)')
        .labelIncludeDot(true)

      (document.getElementById('globe'));

    // Auto-rotate
    world.controls().autoRotate = globeAnimate;
    world.controls().autoRotateSpeed = 0.35;

}
   </script>

  <div class="row">
    <div class="column">
      <input type="file" class="input_button" style="width:400" ACCEPT="text/html" onchange="openFileFunction(event,1)" />
    </div>
    <div class="column">
      <input type="file" class="input_button" style="width:400" ACCEPT="text/html" onchange="openFileFunction(event,2)" />
    </div>
  </div>
  <div class="row">
    <div class="column">
      <p class="header" style="display:none">&#128309;&nbsp;&nbsp; Kit: [<b id="kit1_number"></b>] <b id="kit1_name"></b> (<b id="kit1_date"></b>)</p>
    </div>
    <div class="column">
      <p class="header" style="display:none">&#128308;&nbsp;&nbsp; Kit: [<b id="kit2_number"></b>] <b id="kit2_name"></b> (<b id="kit2_date"></b>)</p>
    </div>
  </div>

  <div id="globeButtons" style="display:none">
    <label for="globeImg">Globe:</label>
    <select name="globeImg" id="globeImg" onChange="changeGlobeImg()">
      <option value="globeDay.jpg" selected>Day</option>
      <option value="globeDay2.jpg">Day 2</option>
      <option value="globeDay3.jpg">Day 3</option>
      <option value="globeBW.jpg">Black and White</option>
      <option value="globeGray.jpg">Gray</option>
      <option value="globeSepia.jpg">Sepia</option>
    </select>
    <select name="globeData" id="globeData" onChange="changeGlobeData()">
      <option value="merge"  id="globeData-merge" selected>All</option>
      <option value="common" id="globeData-common">Common</option>
      <option value="diff" id="globeData-diff">Diff</option>
      <option value="diff-kit1" id="globeData-diff-kit1">Diff1</option>
      <option value="diff-kit2" id="globeData-diff-kit2">Diff2</option>
      <option value="kit1" id="globeData-kit1">none</option>
      <option value="kit2" id="globeData-kit2">none</option>
    </select>
    <label style="padding-left:12;margin-right:0" for="globeShowLabels"> Labels:</label>
    <input type="checkbox" id="globeShowLabels" onchange="toggleGlobeLabels(this)" />
    <label style="padding-left:12;margin-right:0" for="globeShowSpikes"> Spikes:</label>
    <input type="checkbox" id="globeShowSpikes" onchange="toggleGlobeSpikes(this)" />
    <label style="padding-left:12;margin-right:0" for="globeAnimation"> Animation:</label>
    <input type="checkbox" id="globeAnimation" onchange="animateGlobe(this)" />
  <br><br>
  </div>
  <div id="globe" style="display:none"></div>

  <div id="rawData" style="display:initial">
  <div class="asb-block">
    <div class="row" id="asb">
      <hr class="header" style="display:none">
      <h3 class="header" style="display:none">Ancient Samples Full Breakdown</h3>
      <div class="column">
        <div id="asb1_buttons" class="dl-button"></div>
        <div id="asb1_chart1" class="result-chart"></div>
        <div id="asb1_result" class="result-table"></div>
      </div>
      <div class="column">
        <div id="asb2_buttons" class="dl-button"></div>
        <div id="asb2_chart1" class="result-chart"></div>
        <div id="asb2_result" class="result-table"></div>
      </div>
    </div>
    <div class="comparison-row" id="asb_combo">
        <div id="asb_combo_buttons" class="dl-button"></div>
        <div id="asb_combo_chart"></div>
        <div id="asb_combo_result"></div>
    </div>
    <div class="comparison-row" id="asb_diffpie">
        <div id="asb_diffpie_buttons" class="dl-button"></div>
        <div style="width: 600px;position: relative;">
          <div id="asb_diffpie_chart" ></div>
          <div>
          <canvas id="asb_diffpie_chart_annotation" width="150" height="130" style="top:160px;left:350px;position: absolute;">
          </canvas>
          </div>
        </div>
        <div id="asb_diffpie_result"></div>
    </div>
  </div>

  <div class="dd-block">
    <div class="row" id="dd">
      <hr class="header" style="display:none">
      <h3 class="header" style="display:none">Deep Dive Full Breakdown</h3>
      <div class="column">
        <div id="dd1_buttons" class="dl-button"></div>
        <div id="dd1_chart1" class="result-chart"></div>
        <div id="dd1_result" class="result-table"></div>
      </div>
      <div class="column">
        <div id="dd2_buttons" class="dl-button"></div>
        <div id="dd2_chart1" class="result-chart"></div>
        <div id="dd2_result" class="result-table"></div>
      </div>
    </div>
    <div class="comparison-row" id="dd_combo">
        <div id="dd_combo_buttons" class="dl-button"></div>
        <div id="dd_combo_chart"></div>
        <div id="dd_combo_result"></div>
    </div>
    <div class="comparison-row" id="dd_diffpie">
        <div id="dd_diffpie_buttons" class="dl-button"></div>
        <div style="width: 600px;position: relative;">
          <div id="dd_diffpie_chart" ></div>
          <div>
          <canvas id="dd_diffpie_chart_annotation" width="150" height="130" style="top:160px;left:350px;position: absolute;">
          </canvas>
          </div>
        </div>
        <div id="dd_diffpie_result"></div>
    </div>
  </div>

  <div class="canc-block">
    <div class="row" id="canc">
      <hr class="header" style="display:none">
      <h3 class="header" style="display:none">Closest Ancient Populations</h3>
      <div class="column">
        <div id="canc1_buttons" class="dl-button"></div>
        <div id="canc1_result" class="result-table"></div>
      </div>
      <div class="column">
        <div id="canc2_buttons" class="dl-button"></div>
        <div id="canc2_result" class="result-table"></div>
      </div>
    </div>
  </div>

  <div class="cmod-block">
    <div class="row" id="cmod">
      <hr class="header" style="display:none">
      <h3 class="header" style="display:none">Closest Modern Populations</h3>
      <div class="column">
        <div id="cmod1_buttons" class="dl-button"></div>
        <div id="cmod1_result" class="result-table"></div>
      </div>
      <div class="column">
        <div id="cmod2_buttons" class="dl-button"></div>
        <div id="cmod2_result" class="result-table"></div>
      </div>
    </div>
  </div>

  <div class="ydna-block">
    <div class="row" id="ydna">
      <hr class="header" style="display:none">
      <h3 class="header" style="display:none">Y-DNA Breakdown</h3>
      <div class="column">
        <div id="ydna1_buttons" class="dl-button"></div>
        <div id="ydna1_chart1" class="result-chart"></div>
        <div id="ydna1_result" class="result-table"></div>
      </div>
      <div class="column">
        <div id="ydna2_buttons" class="dl-button"></div>
        <div id="ydna2_chart1" class="result-chart"></div>
        <div id="ydna2_result" class="result-table"></div>
      </div>
    </div>
    <div class="comparison-row" id="ydna_combo">
        <div id="ydna_combo_buttons" class="dl-button"></div>
        <div id="ydna_combo_chart"></div>
        <div id="ydna_combo_result"></div>
    </div>
    <div class="comparison-row" id="ydna_diffpie">
        <div id="ydna_diffpie_buttons" class="dl-button"></div>
        <div style="width: 600px;position: relative;">
          <div id="ydna_diffpie_chart" ></div>
          <div>
          <canvas id="ydna_diffpie_chart_annotation" width="150" height="130" style="top:160px;left:350px;position: absolute;">
          </canvas>
          </div>
        </div>
        <div id="ydna_diffpie_result"></div>
    </div>
  </div>

  <div class="mtdna-block">
    <div class="row" id="mtdna">
      <hr class="header" style="display:none">
      <h3 class="header" style="display:none">mtDNA Breakdown</h3>
      <div class="column">
        <div id="mtdna1_buttons" class="dl-button"></div>
        <div id="mtdna1_chart1" class="result-chart"></div>
        <div id="mtdna1_result" class="result-table"></div>
      </div>
      <div class="column">
        <div id="mtdna2_buttons" class="dl-button"></div>
        <div id="mtdna2_chart1" class="result-chart"></div>
        <div id="mtdna2_result" class="result-table"></div>
      </div>
    </div>
    <div class="comparison-row" id="mtdna_combo">
        <div id="mtdna_combo_buttons" class="dl-button"></div>
        <div id="mtdna_combo_chart"></div>
        <div id="mtdna_combo_result"></div>
    </div>
    <div class="comparison-row" id="mtdna_diffpie">
        <div id="mtdna_diffpie_buttons" class="dl-button"></div>
        <div style="width: 600px;position: relative;">
          <div id="mtdna_diffpie_chart" ></div>
          <div>
          <canvas id="mtdna_diffpie_chart_annotation" width="150" height="130" style="top:160px;left:350px;position: absolute;">
          </canvas>
          </div>
        </div>
        <div id="mtdna_diffpie_result"></div>
    </div>
  </div>

  <div class="sm-block">
    <div class="row" id="sm">
      <hr class="header" style="display:none">
      <h3 class="header" style="display:none">The Closest Archaeogenetic matches</h3>
      <div class="column">
        <div id="sm1_buttons" class="dl-button"></div>
        <div id="sm1_result" class="result-table"></div>
      </div>
      <div class="column">
        <div id="sm2_buttons" class="dl-button"></div>
        <div id="sm2_result" class="result-table"></div>
      </div>
    </div>
  </div>

  <div class="ddar-block">
    <div class="row" id="ddar">
      <hr class="header" style="display:none">
      <h3 class="header" style="display:none">Deep Dive - Ancient Relatives</h3>
      <div class="column">
        <div id="ddar1_buttons" class="dl-button"></div>
        <div id="ddar1_result" class="result-table"></div>
      </div>
      <div class="column">
        <div id="ddar2_buttons" class="dl-button"></div>
        <div id="ddar2_result" class="result-table"></div>
      </div>
    </div>
  </div>

  <div class="haploexp-block">
    <div class="row" id="haploexp">
      <hr class="header" style="display:none">
      <h3 class="header" style="display:none">All Samples</h3>
      <div class="column">
        <div id="haploexp1_buttons" class="dl-button"></div>
        <div id="haploexp1_result" class="result-table"></div>
      </div>
      <div class="column">
        <div id="haploexp2_buttons" class="dl-button"></div>
        <div id="haploexp2_result" class="result-table"></div>
      </div>
    </div>
  </div>
  </div>
   </body>
</html>
